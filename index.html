<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Palacio Skins Scorecard</title>
<style>
/* UPDATED: Google Font Import for Montserrat */
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');

body {
    /* UPDATED: Font family to Montserrat, keeping other styles */
    font-family: 'Montserrat', 'Inter', Arial, sans-serif; /* Montserrat as primary, Inter as fallback */
    margin: 1rem;
    max-width: 700px;
    background-color: #f8fbfd; /* Very subtle light blue-grey */
    color: #333; /* Darker default text for better contrast */
}

/* NEW: Apply font to form elements and buttons for consistency */
button, input, select, textarea {
    font-family: 'Montserrat', 'Inter', Arial, sans-serif;
}


/* Heading colors for a touch of accent */
h1, h3 {
    color: #2c3e50; /* A darker, slightly desaturated blue-grey */
}

label, select, input { display: block; margin: 0.5rem 0; }
.score-options input[type="radio"] { margin-right: 0.3rem; }
.score-options label { margin: 0.3rem 0; padding: 0.3rem; border: 1px solid #ccc; border-radius: 4px; background: #f3f3f3; cursor: pointer; }
.score-options input[type="radio"]:checked + label {
    background-color: #d6eaff; /* Slightly brighter light blue */
    border-color: #007bff; /* Keep original strong blue for checked state */
}
.hidden { display: none; }
table { width: 100%; margin-top: 1rem; border-collapse: collapse; }
th, td { border: 1px solid #ccc; padding: 0.4rem; text-align: center; }

/* Table header background for a bit of color */
th {
    background-color: #e9f5f9; /* Very light blue background for table headers */
    color: #2c3e50; /* Match heading color */
}

.admin { background: #f9f9f9; padding: 1rem; margin-top: 1rem; border: 1px solid #ccc; }
#recap:empty { display: none; }

/* Style for highlighting current hole */
.current-hole {
    background-color: #e0f2f7; /* Light blue background */
    font-weight: bold;
    border-color: #007bff; /* Stronger border */
}

/* Modern button styles */
button {
    background-color: #3498db; /* A standard soft blue */
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.2s ease; /* Smooth transition on hover */
}

button:hover {
    background-color: #2980b9; /* Darker blue on hover */
}

/* Celebration Message Styles */
#celebrationMessage {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #4CAF50;
    color: white;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 1.8rem;
    font-weight: bold;
    text-align: center;
    z-index: 1000;
    opacity: 1;
    transition: opacity 0.5s ease-out;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    pointer-events: none;
}

#celebrationMessage.hidden {
    opacity: 0;
}

</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<h1>Palacio Skins Scorecard</h1>

<!-- MOVED: Recap section is now here, at the top -->
<pre id="recap" style="margin-top:1rem; white-space:pre-wrap; border:1px dashed #999; padding:1rem;"></pre>

<div id="scorecard"></div>

<form id="scoreForm">
<label for="player">Player:</label>
<select id="player" required>
<option value="">-- Select Player --</option>
<option>Alex Kim</option>
<option>Alex Mattfolk</option>
<option>Beau Schmitt</option>
<option>Brett Heater</option>
<option>Buzz Gibbs</option>
<option>Chris Burman</option>
<option>Commish</option>
<option>Craig Sanger</option>
<option>Curtis Strand</option>
<option>Dan Gilliam</option>
<option>Daniel Nunez</option>
<option>Elijah Peterson</option>
<option>Eric Ingersoll</option>
<option>Erik Allison</option>
<option>Gary Dilworth</option>
<option>Gavin Lodge</option>
<option>Jared Sanderson</option>
<option>Jay Nakamura</option>
<option>Jeff Jordan</option>
<option>Jermell Mitchell</option>
<option>Jim Giubilato</option>
<option>Jory Adam</option>
<option>Mark Gresser</option>
<option>Mike Hurvitz</option>
<option>Neil Gerber</option>
<option>Roman Alper</option>
<option>Ryan Haight</option>
<option>Sean Edwards</option>
<option>Steve Bonner</option>
<option>Steve Jess</option>
<option>Other</option>
</select>
<input id="otherPlayer" placeholder="Enter player name" class="hidden" />

<label for="week">Week Number:</label>
<input type="number" id="week" min="1" required />

<button id="startRound" type="button">Start Round</button>
<div id="holeSection"></div>
</form>

<div id="summary"></div>
<div id="adminTools" class="admin hidden"></div>


<div id="celebrationMessage" class="hidden"></div>

<script>
const SUPABASE_URL = 'https://htsipaxeqaumxntsrsvx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0c2lwYXhlcWF1bXhudHNyc3Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMjU1NDQsImV4cCI6MjA2NjkwMTU0NH0.AY4mcj85_xWSz2HI2A16kigH58PqAFoEDqZgULcen88';
const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const maxHoles = 9;
let currentHole = 1;
const scores = {};

const form = document.getElementById('scoreForm');
const holeSection = document.getElementById('holeSection');
const scorecard = document.getElementById('scorecard');
const summary = document.getElementById('summary');
const adminPanel = document.getElementById('adminTools');
const startRoundButton = document.getElementById('startRound');
const playerSelect = document.getElementById('player');
const weekInput = document.getElementById('week');

// --- Global variables to manage Supabase channel subscriptions ---
let currentRecapChannel = null;
let currentLiveScoresChannel = null;

playerSelect.addEventListener('change', (e) => {
    const otherPlayerInput = document.getElementById('otherPlayer');
    otherPlayerInput.classList.toggle('hidden', e.target.value !== 'Other');
    if (e.target.value === 'Other') {
        otherPlayerInput.focus();
    }
    loadAndListenRecap();
});

weekInput.addEventListener('change', loadAndListenRecap);


function renderScorecard() {
    let html = '<h3>Your Scorecard</h3>';
    html += '<table><tr><th>Hole</th>';
    for (let i = 1; i <= maxHoles; i++) {
        html += `<th class="${i === currentHole ? 'current-hole' : ''}">${i}</th>`;
    }
    html += '</tr><tr><td>Score</td>';
    for (let i = 1; i <= maxHoles; i++) {
        html += `<td class="${i === currentHole ? 'current-hole' : ''}">${scores[i] || '-'}</td>`;
    }
    html += '</tr></table>';
    scorecard.innerHTML = html;
}

function renderHoleForm() {
    holeSection.innerHTML = '';
    if (currentHole > maxHoles) {
        holeSection.innerHTML = '<p>All holes submitted. <button onclick="location.reload()">Restart</button></p>';
        return;
    }
    const div = document.createElement('div');
    div.innerHTML = `
        <h3>Hole ${currentHole}</h3>
        <div class="score-options">
            <label><input type="radio" name="score" value="1"> Hole-in-One</label>
            <label>
                <input type="radio" name="score" value="2"> Birdie
                <span id="chipInOption" class="hidden">
                    <input type="checkbox" id="chipIn"> Chip-in
                </span>
            </label>
            <label><input type="radio" name="score" value="3+" checked> Par or Worse</label>
        </div>
        <div id="ctpContainer" class="${currentHole === 9 ? '' : 'hidden'}">
            <label><input type="checkbox" id="ctp"> Closest to the Pin</label>
        </div>
        <button type="button" onclick="handleHoleSubmit()">Submit Hole</button>
    `;
    holeSection.appendChild(div);

    const chipInOptionSpan = document.getElementById('chipInOption');
    const birdieRadio = div.querySelector('input[value="2"]');

    birdieRadio.addEventListener('change', () => chipInOptionSpan.classList.remove('hidden'));
    div.querySelectorAll('input[name="score"]').forEach(input => {
        if (input.value !== '2') input.addEventListener('change', () => chipInOptionSpan.classList.add('hidden'));
    });
}

async function handleHoleSubmit() {
    const player = playerSelect.value === 'Other'
        ? document.getElementById('otherPlayer').value.trim()
        : playerSelect.value;
    const week = parseInt(weekInput.value);
    const scoreInput = holeSection.querySelector('input[name="score"]:checked');
    if (!player || !week || !scoreInput) return alert('Fill in all fields');

    let score = scoreInput.value;
    const chipIn = document.getElementById('chipIn')?.checked;
    if (score === '2' && chipIn) score = '2*';
    const ctp = document.getElementById('ctp')?.checked || false;

    const submission = { player, week_number: week, hole: currentHole, score, ctp };

    try {
        const { error } = await client.from('Submissions').insert([submission]);
        if (error) throw error;
    } catch (err) {
        alert('Error submitting: ' + err.message);
        return;
    }

    scores[currentHole] = score;
    renderScorecard();
    currentHole++;
    renderHoleForm();

    renderLiveSummary();

    // Celebration Message Logic
    const celebrationMessageDiv = document.getElementById('celebrationMessage');
    let messageText = '';

    if (score === '1') {
        messageText = 'ðŸŽ‰ ACE! Hole-in-One! ðŸŽ‰';
    } else if (score === '2') {
        messageText = 'ðŸ¦ Birdie!';
    } else if (score === '2*') {
        messageText = 'âœ¨ Chip-in Birdie!';
    }

    if (messageText) {
        celebrationMessageDiv.textContent = messageText;
        celebrationMessageDiv.classList.remove('hidden');
        setTimeout(() => {
            celebrationMessageDiv.classList.add('hidden');
        }, 2500); // Hide after 2.5 seconds
    }
}

function listenToRecap(weekNumber) {
    if (currentRecapChannel) {
        client.removeChannel(currentRecapChannel);
        currentRecapChannel = null;
    }

    client
        .from('recaps')
        .select('recap_text')
        .eq('week_number', weekNumber)
        .single()
        .then(({ data }) => {
            if (data && data.recap_text) {
                document.getElementById('recap').textContent = data.recap_text;
            } else {
                document.getElementById('recap').textContent = '';
            }
        });

    const channelName = `recap_week_${weekNumber}`;
    currentRecapChannel = client.channel(channelName)
        .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'recaps',
            filter: `week_number=eq.${weekNumber}`
        }, payload => {
            document.getElementById('recap').textContent = payload.new.recap_text;
        })
        .subscribe();
}

function listenToLiveScores(weekNumber) {
    if (currentLiveScoresChannel) {
        client.removeChannel(currentLiveScoresChannel);
        currentLiveScoresChannel = null;
    }

    const channelName = `submissions_week_${weekNumber}`;
    currentLiveScoresChannel = client.channel(channelName)
        .on(
            'postgres_changes',
            { event: 'INSERT', schema: 'public', table: 'Submissions', filter: `week_number=eq.${weekNumber}` },
            () => renderLiveSummary()
        )
        .subscribe();
}

function loadAndListenRecap() {
    const week = parseInt(weekInput.value);

    if (!isNaN(week) && week > 0) {
        listenToRecap(week);
        listenToLiveScores(week);
        renderLiveSummary();

        if (["Commish", "Craig Sanger"].includes(playerSelect.value)) {
            const finalWeekInput = document.getElementById('finalWeek');
            if (finalWeekInput) {
                finalWeekInput.value = week;
            }
        }

    } else {
        document.getElementById('recap').textContent = '';
        summary.innerHTML = '';
        if (currentRecapChannel) {
            client.removeChannel(currentRecapChannel);
            currentRecapChannel = null;
        }
        if (currentLiveScoresChannel) {
            client.removeChannel(currentLiveScoresChannel);
            currentLiveScoresChannel = null;
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const today = new Date();

    // Only apply default week logic if the current year is 2025
    if (today.getFullYear() === 2025) {
        const currentDay = today.getDay(); // 0 (Sunday) to 6 (Saturday)
        const currentMonday = new Date(today); // Create a copy

        // Adjust to the current week's Monday (the start of your defined week)
        const daysToSubtract = currentDay === 0 ? 6 : currentDay - 1; // If Sunday (0), go back 6 days; otherwise, go back (day - 1) days
        currentMonday.setDate(today.getDate() - daysToSubtract);
        currentMonday.setHours(0, 0, 0, 0); // Normalize to start of day

        const referenceDate = new Date('2025-06-30T00:00:00'); // Week 9 reference (June 30, 2025 was a Monday)
        referenceDate.setHours(0,0,0,0); // Normalize reference date to start of day

        const msPerWeek = 1000 * 60 * 60 * 24 * 7;
        const diffMs = currentMonday.getTime() - referenceDate.getTime();
        const diffWeeks = Math.round(diffMs / msPerWeek); // Calculate difference in weeks

        const defaultCalculatedWeek = 9 + diffWeeks; // Adjusted to Week 9
        weekInput.value = defaultCalculatedWeek; // Set the calculated week as the default
    }

    loadAndListenRecap();
    renderLiveSummary();
});


startRoundButton.addEventListener('click', () => {
    const player = playerSelect.value;
    const week = weekInput.value;
    if (!player || !week) return alert('Please select a player and enter a week number first.');

    startRoundButton.classList.add('hidden');
    playerSelect.disabled = true;
    weekInput.disabled = true;

    currentHole = 1;
    for (let i = 1; i <= maxHoles; i++) delete scores[i];
    renderScorecard();
    renderHoleForm();
});

function renderLiveSummary() {
    const week = parseInt(weekInput.value);
    if (!week) {
        summary.innerHTML = '';
        return;
    }
    client
        .from('Submissions')
        .select('*')
        .eq('week_number', week)
        .then(({ data, error }) => {
            if (error || !data) {
                summary.innerHTML = '<p>Error loading summary</p>';
                return;
            }

            const holeStats = {};
            for (let i = 1; i <= 9; i++) {
                holeStats[i] = { birdies: 0, chipins: 0, aces: 0 };
            }

            data.forEach(({ hole, score }) => {
                if (!holeStats[hole]) return;
                if (score === '1') holeStats[hole].aces++;
                else if (score === '2') holeStats[hole].birdies++;
                else if (score === '2*') holeStats[hole].chipins++;
            });

            let html = '<table><tr><th>Hole</th><th>Birdies</th><th>Chip-ins</th><th>Aces</th></tr>';
            for (let i = 1; i <= 9; i++) {
                const h = holeStats[i];
                html += `<tr><td>${i}</td><td>${h.birdies}</td><td>${h.chipins}</td><td>${h.aces}</td></tr>`;
            }
            html += '</table>';
            summary.innerHTML = html;
        });
}

document.getElementById('player').addEventListener('change', () => {
    const player = playerSelect.value;
    const week = weekInput.value || 1;

    if (["Commish", "Craig Sanger"].includes(player)) {
        adminPanel.classList.remove("hidden");
        adminPanel.innerHTML = `
            <h3>Admin Tools</h3>
            <label>Week to Finalize: <input type="number" id="finalWeek" min="1" value="${week}" /></label>
            <button onclick="finalizeScores()">ðŸ’° Finalize Scores & Calculate Payouts</button>
            <button onclick="clearWeek()">ðŸ—‘ Clear Week</button>
            <pre id="adminResults">Admin Results will appear here.</pre>
        `;
        document.getElementById('finalWeek').addEventListener('change', () => {
            const adminWeek = parseInt(document.getElementById('finalWeek').value);
            if (!isNaN(adminWeek) && adminWeek > 0) {
                listenToRecap(adminWeek);
            }
        });
        if (!isNaN(parseInt(week)) && parseInt(week) > 0) {
            listenToRecap(parseInt(week));
        }

    } else {
        adminPanel.classList.add("hidden");
        loadAndListenRecap();
    }
});


async function finalizeScores() {
    const week = parseInt(document.getElementById('finalWeek').value);
    if (!week) return alert('Enter a week number.');

    const { data, error } = await client
        .from('Submissions')
        .select('*')
        .eq('week_number', week);

    if (error || !data || data.length === 0) {
        document.getElementById('adminResults').textContent = 'Error or no data for this week.';
        return;
    }

    let recap = '';
    const byHole = {};
    for (let i = 1; i <= 9; i++) byHole[i] = [];
    data.forEach(entry => byHole[entry.hole].push(entry));

    const aceWinners = data.filter(d => d.score === '1');

    if (aceWinners.length > 0) {
        const names = aceWinners.map(a => a.player).join(',
