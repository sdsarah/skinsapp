<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Palacio Skins Scorecard</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 2rem auto;
      padding: 0 1rem;
      max-width: 720px;
      background: #fff;
    }
    h1, h3 {
      font-weight: 600;
    }
    label {
      font-weight: 500;
      display: block;
      margin-top: 1rem;
    }
    input[type="number"], select {
      width: 100%;
      max-width: 240px;
      padding: 0.5rem;
      font-size: 1rem;
      margin-top: 0.3rem;
    }
    input[type="radio"], input[type="checkbox"] {
      margin-right: 0.5rem;
    }
    button {
      margin-top: 1.2rem;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 4px;
      background: #0366d6;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #024fa0;
    }
    .secondary-button {
      background-color: #444;
    }
    .secondary-button:hover {
      background-color: #222;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.6rem;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    #admin-results {
      background-color: #f9f9f9;
      padding: 1rem;
      border: 1px solid #ddd;
      white-space: pre-wrap;
      margin-top: 2rem;
    }
  </style>
</head>
<body>

  <h1>Palacio Skins Scorecard</h1>

  <form id="score-form">
    <label for="player">Player:</label>
    <select id="player" required>
      <option value="" disabled selected>Select a player</option>
    </select>

    <label for="week-number">Week Number:</label>
    <input type="number" id="week-number" required min="1" />

    <h3 id="hole-label">Hole 1</h3>
    <div id="score-options">
      <label><input type="radio" name="score" value="1"> Hole-in-One</label>
      <label><input type="radio" name="score" value="2"> Birdie</label>
      <label><input type="radio" name="score" value="2*"> Chip-in Birdie</label>
      <label><input type="radio" name="score" value="3+" checked> Par or Worse</label>
    </div>

    <div id="ctp-container" style="display: none;">
      <label><input type="checkbox" id="ctp"> Closest to Pin (CTP)</label>
    </div>

    <button type="submit">Submit Hole</button>
  </form>

  <div id="result-message"></div>

  <div id="scorecard">
    <h3>Player Scorecard</h3>
    <table>
      <thead>
        <tr><th>Hole</th><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td></tr>
      </thead>
      <tbody>
        <tr id="scorecard-row">
          <th>Score</th>
          <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="admin-tools" style="display:none;">
    <h3>Admin Tools</h3>
    <label for="admin-week">Week to Finalize:</label>
    <input type="number" id="admin-week" value="1" min="1" />
    <button id="calculate-payouts">üí∞ Finalize Scores & Calculate Payouts</button>
    <button id="clear-week" style="background:#e00;">üóë Clear Week</button>
    <button id="email-results" class="secondary-button">‚úâÔ∏è Email Results to Craig</button>
    <pre id="admin-results"></pre>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://htsipaxeqaumxntsrsvx.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0c2lwYXhlcWF1bXhudHNyc3Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMjU1NDQsImV4cCI6MjA2NjkwMTU0NH0.AY4mcj85_xWSz2HI2A16kigH58PqAFoEDqZgULcen88'
    );

    const playerSelect = document.getElementById('player');
    const players = ["Commish", "Craig Sanger", "Alex Kim", "Alex Mattfolk", "Beau Schmitt", "Brett Heater", "Buzz Gibbs", "Chris Burman", "Curtis Strand", "Dan Gilliam", "Daniel Nunez", "Elijah Peterson", "Eric Ingersoll", "Erik Allison", "Gavin Lodge", "Gary Dilworth", "Jared Sanderson", "Jay Nakamura", "Jeff Jordan", "Jermell Mitchell", "Jim Giubilato", "Jory Adam", "Mark Gresser", "Mike Hurvitz", "Neil Gerber", "Roman Alper", "Ryan Haight", "Sean Edwards", "Steve Bonner", "Steve Jess"];
    players.forEach(name => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      playerSelect.appendChild(option);
    });

    let currentHole = 1;
    const scorecard = Array(9).fill('-');

    document.getElementById('score-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const player = playerSelect.value;
      const week = +document.getElementById('week-number').value;
      const score = document.querySelector('input[name="score"]:checked')?.value;
      const ctp = currentHole === 9 && document.getElementById('ctp').checked;
      if (!player || !week || !score) return alert('Fill in all fields');

      const { error } = await supabase.from('Submissions').insert([{ player, week_number: week, hole: currentHole, score, ctp }]);
      if (error) return alert('Error submitting: ' + error.message);

      scorecard[currentHole - 1] = score;
      document.querySelector(`#scorecard-row td:nth-child(${currentHole})`).textContent = score;

      currentHole++;
      document.getElementById('hole-label').textContent = `Hole ${currentHole}`;
      document.querySelectorAll('input[name="score"]').forEach(i => i.checked = false);
      document.getElementById('ctp').checked = false;
      document.getElementById('ctp-container').style.display = currentHole === 9 ? 'block' : 'none';

      if (currentHole > 9) {
        document.getElementById('score-form').remove();
        const msg = document.getElementById('result-message');
        msg.innerHTML = '‚úÖ All 9 holes submitted!<br>';
        const restart = document.createElement('button');
        restart.textContent = 'Start Over';
        restart.onclick = () => location.reload();
        msg.appendChild(restart);
      }
    });

    playerSelect.addEventListener('change', () => {
      const isAdmin = ["Craig Sanger", "Commish"].includes(playerSelect.value);
      document.getElementById('admin-tools').style.display = isAdmin ? 'block' : 'none';
    });

    document.getElementById('calculate-payouts').onclick = async () => {
      const week = +document.getElementById('admin-week').value;
      const { data, error } = await supabase.from('Submissions').select('*').eq('week_number', week);
      const out = document.getElementById('admin-results');
      if (error) return out.textContent = '‚ùå ' + error.message;

      const byHole = {}, shareMap = {}, aces = [], ctps = [];
      let totalShares = 0;

      data.forEach(r => {
        if (!byHole[r.hole]) byHole[r.hole] = [];
        byHole[r.hole].push(r);
        if (r.score === '1') aces.push(r);
        if (r.ctp) ctps.push(r);
      });

      let res = '';
      if (aces.length) {
        const winners = [...new Set(aces.map(r => r.player))];
        const prize = (300 / winners.length).toFixed(2);
        res += `üéØ Hole-in-One Winner(s):\n` + winners.map(p => `- ${p}: $${prize}`).join('\n');
      } else {
        for (const hole in byHole) {
          const b = byHole[hole].filter(r => r.score === '2');
          const c = byHole[hole].filter(r => r.score === '2*');
          if (b.length === 1 && c.length === 0) {
            shareMap[b[0].player] = (shareMap[b[0].player] || 0) + 1;
            totalShares++;
          }
          if (c.length === 1 && b.length === 0) {
            shareMap[c[0].player] = (shareMap[c[0].player] || 0) + 2;
            totalShares += 2;
          }
        }
        res += `\nüí∏ Skin Results:\n`;
        if (!totalShares) res += `- No skins awarded.`;
        else for (const [p, s] of Object.entries(shareMap)) {
          const amt = ((300 * s) / totalShares).toFixed(2);
          res += `- ${p}: $${amt} (${s} share${s > 1 ? 's' : ''})\n`;
        }
      }

      const ctpWinner = ctps.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at))[0]?.player || 'Commish';
      res += `\nüéØ CTP Winner: ${ctpWinner} ($30)`;
      out.textContent = res;
    };

    document.getElementById('clear-week').onclick = async () => {
      const week = +document.getElementById('admin-week').value;
      if (!week || !confirm(`Clear all entries for week ${week}?`)) return;
      const { error } = await supabase.from('Submissions').delete().eq('week_number', week);
      document.getElementById('admin-results').textContent = error ? '‚ùå ' + error.message : `‚úÖ Week ${week} cleared.`;
    };

    document.getElementById('email-results').onclick = () => {
      const output = document.getElementById('admin-results').textContent.trim();
      if (!output) return alert('Run payout calc first.');
      const mailto = `mailto:craig.m.sanger@gmail.com?subject=${encodeURIComponent('Palacio Skins Results')}&body=${encodeURIComponent(output)}`;
      window.open(mailto);
    };
  </script>

</body>
</html>
