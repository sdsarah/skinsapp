<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Palacio Skins Scorecard</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
      max-width: 700px;
    }
    h1, h2, h3 { margin-bottom: 0.5rem; }
    form {
      background: #f9f9f9;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 1.5rem;
    }
    label { display: block; margin-top: 0.75rem; }
    select, input[type="number"] {
      margin-top: 0.3rem;
      padding: 0.4rem;
      width: 100%;
      max-width: 200px;
    }
    input[type="radio"], input[type="checkbox"] { margin-right: 0.4rem; }
    button {
      margin-top: 1rem;
      padding: 0.6rem 1.2rem;
      border: none;
      background: #0366d6;
      color: white;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #024fa0; }
    #result-message { margin-top: 1rem; font-weight: bold; }
    #scorecard, #live-summary { margin-top: 2rem; }
    table {
      width: 100%;
      margin-top: 0.5rem;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.6rem;
      text-align: center;
    }
    th { background: #eee; }
    .scorecard-row th {
      background: #f0f0f0;
      width: 80px;
    }
  </style>
</head>
<body>
  <h1>Palacio Skins Scorecard</h1>

  <form id="score-form">
    <label for="player">Player:</label>
    <select id="player" name="player" required>
      <option value="">Select player</option>
    </select>

    <label for="week-number">Week Number:</label>
    <input type="number" id="week-number" name="week_number" required min="1">

    <h3 id="hole-label">Hole 1</h3>
    <div id="score-options">
      <label><input type="radio" name="score" value="1" required> Hole-in-One</label><br>
      <label><input type="radio" name="score" value="2"> Birdie</label><br>
      <label><input type="radio" name="score" value="2*"> Chip-in Birdie</label><br>
      <label><input type="radio" name="score" value="3+"> Par or Worse</label><br>
    </div>

    <div id="ctp-container" style="display: none;">
      <label><input type="checkbox" id="ctp" name="ctp"> Closest to Pin (CTP)</label>
    </div>

    <button type="submit">Submit Hole</button>
  </form>

  <div id="result-message"></div>

  <div id="scorecard">
    <h3>Player Scorecard</h3>
    <table>
      <tbody>
        <tr class="scorecard-row">
          <th>Hole</th>
          <td id="hole-1">1</td>
          <td id="hole-2">2</td>
          <td id="hole-3">3</td>
          <td id="hole-4">4</td>
          <td id="hole-5">5</td>
          <td id="hole-6">6</td>
          <td id="hole-7">7</td>
          <td id="hole-8">8</td>
          <td id="hole-9">9</td>
        </tr>
        <tr class="scorecard-row">
          <th>Score</th>
          <td id="score-1">-</td>
          <td id="score-2">-</td>
          <td id="score-3">-</td>
          <td id="score-4">-</td>
          <td id="score-5">-</td>
          <td id="score-6">-</td>
          <td id="score-7">-</td>
          <td id="score-8">-</td>
          <td id="score-9">-</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="live-summary">
    <h3>Live Summary</h3>
    <label for="summary-week">Week:</label>
    <input type="number" id="summary-week" min="1" value="1">
    <table>
      <thead>
        <tr>
          <th>Hole</th>
          <th>Birdies</th>
          <th>Chip-ins</th>
          <th>Aces</th>
        </tr>
      </thead>
      <tbody id="summary-body"></tbody>
    </table>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabaseUrl = 'https://htsipaxeqaumxntsrsvx.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0c2lwYXhlcWF1bXhudHNyc3Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMjU1NDQsImV4cCI6MjA2NjkwMTU0NH0.AY4mcj85_xWSz2HI2A16kigH58PqAFoEDqZgULcen88';
    const supabase = createClient(supabaseUrl, supabaseKey);

    const players = ["Commish", "Craig Sanger", "Alex Kim", "Alex Mattfolk", "Beau Schmitt", "Brett Heater", "Buzz Gibbs", "Chris Burman", "Curtis Strand", "Dan Gilliam", "Daniel Nunez", "Elijah Peterson", "Eric Ingersoll", "Erik Allison", "Gavin Lodge", "Gary Dilworth", "Jared Sanderson", "Jay Nakamura", "Jeff Jordan", "Jermell Mitchell", "Jim Giubilato", "Jory Adam", "Mark Gresser", "Mike Hurvitz", "Neil Gerber", "Roman Alper", "Ryan Haight", "Sean Edwards", "Steve Bonner", "Steve Jess"];

    const playerSelect = document.getElementById('player');
    players.forEach(name => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      playerSelect.appendChild(option);
    });

    let currentHole = 1;
    const scorecard = Array(9).fill('-');

    function updateUIAfterSubmit() {
      currentHole++;
      document.getElementById('hole-label').textContent = `Hole ${currentHole}`;
      document.querySelectorAll('input[name="score"]').forEach(input => input.checked = false);
      document.getElementById('ctp').checked = false;
      document.getElementById('ctp-container').style.display = currentHole === 9 ? 'block' : 'none';
      scorecard.forEach((s, i) => {
        document.getElementById(`score-${i + 1}`).textContent = s;
      });
      if (currentHole > 9) {
        document.getElementById('score-form').style.display = 'none';
        const restartBtn = document.createElement('button');
        restartBtn.textContent = 'Start Over';
        restartBtn.onclick = () => location.reload();
        document.getElementById('result-message').textContent = '✅ All 9 holes submitted!';
        document.getElementById('result-message').appendChild(document.createElement('br'));
        document.getElementById('result-message').appendChild(restartBtn);
      }
    }

    document.getElementById('score-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const player = document.getElementById('player').value;
      const weekNumber = parseInt(document.getElementById('week-number').value, 10);
      const scoreInput = document.querySelector('input[name="score"]:checked');
      const score = scoreInput ? scoreInput.value : null;
      const ctp = currentHole === 9 ? document.getElementById('ctp').checked : false;

      if (!score || !player || !weekNumber || isNaN(currentHole)) {
        alert("Please fill in all fields.");
        return;
      }

      const submission = { player, week_number: weekNumber, hole: currentHole, score, ctp };
      const { data, error } = await supabase.from('Submissions').insert([submission]);

      const messageEl = document.getElementById('result-message');
      if (error) {
        console.error('Supabase error:', error);
        messageEl.textContent = `❌ Error: ${error.message}`;
        messageEl.style.color = 'red';
        return;
      }

      scorecard[currentHole - 1] = score;
      messageEl.textContent = `✅ Hole ${currentHole} submitted!`;
      messageEl.style.color = 'green';
      updateUIAfterSubmit();
      loadLiveSummary(weekNumber);
    });

    async function loadLiveSummary(week) {
      const { data, error } = await supabase.from('Submissions').select('hole, score').eq('week_number', week);
      if (error) {
        console.error('Summary fetch error:', error);
        return;
      }
      const summary = Array.from({ length: 9 }, (_, i) => ({ hole: i + 1, birdies: 0, chipins: 0, aces: 0 }));
      for (const row of data) {
        const h = row.hole - 1;
        if (row.score === '2') summary[h].birdies++;
        else if (row.score === '2*') summary[h].chipins++;
        else if (row.score === '1') summary[h].aces++;
      }
      const tbody = document.getElementById('summary-body');
      tbody.innerHTML = '';
      summary.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.hole}</td><td>${r.birdies}</td><td>${r.chipins}</td><td>${r.aces}</td>`;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('summary-week').addEventListener('input', (e) => {
      const week = parseInt(e.target.value, 10);
      if (week > 0) loadLiveSummary(week);
    });

    window.addEventListener('load', () => {
      const defaultWeek = parseInt(document.getElementById('summary-week').value, 10);
      if (defaultWeek > 0) loadLiveSummary(defaultWeek);
    });
  </script>
</body>
</html>
