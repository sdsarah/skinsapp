<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Palacio Skins Scorecard</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 2rem auto;
      padding: 0 1rem;
      max-width: 720px;
      background: #fff;
    }
    h1, h3 {
      font-weight: 600;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    select, input[type="number"] {
      width: 100%;
      max-width: 300px;
      padding: 0.5rem;
      margin-top: 0.3rem;
    }
    input[type="radio"], input[type="checkbox"] {
      margin-right: 0.5rem;
    }
    button {
      margin-top: 1rem;
      padding: 0.6rem 1rem;
      font-size: 1rem;
      background: #0366d6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #024fa0;
    }
    table {
      width: 100%;
      margin-top: 1rem;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.6rem;
      text-align: center;
    }
    th {
      background: #f0f0f0;
    }
    #admin-results {
      white-space: pre-wrap;
      background: #f9f9f9;
      padding: 1rem;
      border: 1px solid #ccc;
      margin-top: 1.5rem;
    }
  </style>
</head>
<body>

<h1>Palacio Skins Scorecard</h1>

<form id="score-form">
  <label for="player">Player:</label>
  <select id="player" required>
    <option value="" disabled selected>Select a player</option>
  </select>

  <label for="week-number">Week Number:</label>
  <input type="number" id="week-number" required min="1" />

  <h3 id="hole-label">Hole 1</h3>
  <div id="score-options">
    <label><input type="radio" name="score" value="1"> Hole-in-One</label>
    <label><input type="radio" name="score" value="2"> Birdie</label>
    <label><input type="radio" name="score" value="2*"> Chip-in Birdie</label>
    <label><input type="radio" name="score" value="3+" checked> Par or Worse</label>
  </div>

  <div id="ctp-container" style="display: none;">
    <label><input type="checkbox" id="ctp"> Closest to Pin (CTP)</label>
  </div>

  <button type="submit">Submit Hole</button>
</form>

<div id="result-message"></div>

<div id="scorecard">
  <h3>Player Scorecard</h3>
  <table>
    <thead>
      <tr><th>Hole</th><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td></tr>
    </thead>
    <tbody>
      <tr id="scorecard-row">
        <th>Score</th>
        <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
      </tr>
    </tbody>
  </table>
</div>

<div id="admin-tools" style="display:none;">
  <h3>Admin Tools</h3>
  <label for="admin-week">Week to Finalize:</label>
  <input type="number" id="admin-week" value="1" min="1" />
  <button id="calculate-payouts">💰 Finalize Scores & Calculate Payouts</button>
  <button id="clear-week" style="background:#e00; color:white;">🗑 Clear Week</button>
  <pre id="admin-results"></pre>
</div>

<div id="live-summary"></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient(
  'https://htsipaxeqaumxntsrsvx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0c2lwYXhlcWF1bXhudHNyc3Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMjU1NDQsImV4cCI6MjA2NjkwMTU0NH0.AY4mcj85_xWSz2HI2A16kigH58PqAFoEDqZgULcen88'
);

document.addEventListener('DOMContentLoaded', () => {
  const playerSelect = document.getElementById('player');
  const players = ["Commish", "Craig Sanger", "Alex Kim", "Alex Mattfolk", "Beau Schmitt", "Brett Heater", "Buzz Gibbs", "Chris Burman", "Curtis Strand", "Dan Gilliam", "Daniel Nunez", "Elijah Peterson", "Eric Ingersoll", "Erik Allison", "Gavin Lodge", "Gary Dilworth", "Jared Sanderson", "Jay Nakamura", "Jeff Jordan", "Jermell Mitchell", "Jim Giubilato", "Jory Adam", "Mark Gresser", "Mike Hurvitz", "Neil Gerber", "Roman Alper", "Ryan Haight", "Sean Edwards", "Steve Bonner", "Steve Jess"];
  players.forEach(name => {
    const option = document.createElement('option');
    option.value = name;
    option.textContent = name;
    playerSelect.appendChild(option);
  });

  playerSelect.addEventListener('change', () => {
    const isAdmin = ["Craig Sanger", "Commish"].includes(playerSelect.value);
    document.getElementById('admin-tools').style.display = isAdmin ? 'block' : 'none';
    const week = +document.getElementById('week-number').value;
    if (isAdmin && week) document.getElementById('admin-week').value = week;
  });

});

let currentHole = 1;
const scorecard = Array(9).fill('-');

async function loadLiveSummary(week) {
  const { data, error } = await supabase.from('Submissions').select('hole, score').eq('week_number', week);
  if (error) return console.error('Live summary error:', error);

  const summary = Array.from({ length: 9 }, (_, i) => ({ hole: i + 1, birdies: 0, chipins: 0, aces: 0 }));
  data.forEach(row => {
    const h = summary[row.hole - 1];
    if (row.score === '2') h.birdies++;
    if (row.score === '2*') h.chipins++;
    if (row.score === '1') h.aces++;
  });

  const table = document.createElement('table');
  table.innerHTML = `
    <thead><tr><th>Hole</th><th>Birdies</th><th>Chip-ins</th><th>Aces</th></tr></thead>
    <tbody>
      ${summary.map(s => `<tr><td>${s.hole}</td><td>${s.birdies}</td><td>${s.chipins}</td><td>${s.aces}</td></tr>`).join('')}
    </tbody>`;
  const target = document.getElementById('live-summary');
  target.innerHTML = '<h3>Live Summary</h3>';
  target.appendChild(table);
}

document.getElementById('score-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const playerSelect = document.getElementById('player');
  const player = playerSelect.value;
  const week = +document.getElementById('week-number').value;
  const score = document.querySelector('input[name="score"]:checked')?.value;
  const ctp = currentHole === 9 && document.getElementById('ctp').checked;
  if (!player || !week || !score) return alert('Fill in all fields');

  const { error } = await supabase.from('Submissions').insert([{ player, week_number: week, hole: currentHole, score, ctp }]);
  if (error) return alert('Error submitting: ' + error.message);

  const cell = document.querySelector(`#scorecard-row td:nth-child(${currentHole + 1})`);
  if (cell) cell.textContent = score;

  currentHole++;
  document.getElementById('hole-label').textContent = `Hole ${currentHole}`;
  document.querySelectorAll('input[name="score"]').forEach(i => i.checked = false);
  document.getElementById('ctp').checked = false;
  document.getElementById('ctp-container').style.display = currentHole === 9 ? 'block' : 'none';

  loadLiveSummary(week);

  if (currentHole > 9) {
    document.getElementById('score-form').remove();
    const msg = document.getElementById('result-message');
    msg.innerHTML = '✅ All 9 holes submitted!<br>';
    const restart = document.createElement('button');
    restart.textContent = 'Start Over';
    restart.onclick = () => location.reload();
    msg.appendChild(restart);
  }
});

document.getElementById('clear-week').onclick = async () => {
  const week = +document.getElementById('admin-week').value;
  if (!week || !confirm(`Clear all entries for week ${week}?`)) return;
  const { error } = await supabase.from('Submissions').delete().eq('week_number', week);
  document.getElementById('admin-results').textContent = error ? '❌ ' + error.message : `✅ Week ${week} cleared.`;
};
document.getElementById('calculate-payouts').onclick = async () => {
  const week = +document.getElementById('admin-week').value;
  const { data, error } = await supabase.from('Submissions').select('*').eq('week_number', week);
  const out = document.getElementById('admin-results');
  if (error) return out.textContent = '❌ ' + error.message;

  const byHole = {}, shareMap = {}, aces = [], ctps = [];
  let totalShares = 0;

  data.forEach(r => {
    if (!byHole[r.hole]) byHole[r.hole] = [];
    byHole[r.hole].push(r);
    if (r.score === '1') aces.push(r);
    if (r.ctp) ctps.push(r);
  });

  let res = '';
  if (aces.length) {
    const winners = [...new Set(aces.map(r => r.player))];
    const prize = (300 / winners.length).toFixed(2);
    res += '🎯 Hole-in-One Winner(s):
' + winners.map(p => `- ${p}: $${prize}`).join('
');
  } else {
    for (const hole in byHole) {
      const scores = byHole[hole];
      const birdies = scores.filter(r => r.score === '2');
      const chipins = scores.filter(r => r.score === '2*');
      if (birdies.length === 1 && chipins.length === 0) {
        const p = birdies[0].player;
        shareMap[p] = (shareMap[p] || 0) + 1;
        totalShares++;
      }
      if (chipins.length === 1 && birdies.length === 0) {
        const p = chipins[0].player;
        shareMap[p] = (shareMap[p] || 0) + 2;
        totalShares += 2;
      }
    }
    res += '
💸 Skin Results:
';
    if (!totalShares) {
      res += `- No skins awarded.`;
    } else {
      for (const [p, s] of Object.entries(shareMap)) {
        const amt = ((300 * s) / totalShares).toFixed(2);
        res += `- ${p}: $${amt} (${s} share${s > 1 ? 's' : ''})
`;
      }
    }
  }

  const recap = [];
  const allHoles = Array.from({ length: 9 }, (_, i) => i + 1);
  allHoles.forEach(hole => {
    const scores = byHole[hole] || [];
    const birdiePlayers = scores.filter(r => r.score === '2').map(r => r.player);
    const chipinPlayers = scores.filter(r => r.score === '2*').map(r => r.player);
    const acePlayers = scores.filter(r => r.score === '1').map(r => r.player);
    const birdieSummary = birdiePlayers.length ? `${birdiePlayers.length} birdie${birdiePlayers.length > 1 ? 's' : ''} (${birdiePlayers.join(', ')})` : 'no birdies';
    const chipinSummary = chipinPlayers.length ? `${chipinPlayers.length} chip-in${chipinPlayers.length > 1 ? 's' : ''} (${chipinPlayers.join(', ')})` : 'no chip-ins';
    const aceSummary = acePlayers.length ? `${acePlayers.length} ace${acePlayers.length > 1 ? 's' : ''} (${acePlayers.join(', ')})` : 'no aces';
    recap.push(`Hole ${hole}: ${birdieSummary}, ${chipinSummary}, ${aceSummary}`);
  });

  const ctpList = ctps.sort((a,b)=>new Date(a.created_at)-new Date(b.created_at)).map(r => r.player);
  const ctpWinner = ctpList.at(-1) || 'Commish';
  res += '

🏁 Full Recap:
' + recap.join('
');
  res += '

🎯 CTP Sequence: ' + ctpList.join(' → ');
  res += '
🎯 Final CTP Winner: ' + ctpWinner + ' ($30)';

  out.textContent = res;
};
</script>

</body>
</html>
