<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Palacio Skins Scorecard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; max-width: 700px; }
    label, select, input { display: block; margin: 0.5rem 0; }
    .score-options input[type="radio"] { margin-right: 0.3rem; }
    .score-options label { margin: 0.3rem 0; padding: 0.3rem; border: 1px solid #ccc; border-radius: 4px; background: #f3f3f3; cursor: pointer; }
    .score-options input[type="radio"]:checked + label {
      background-color: #cce5ff;
      border-color: #66afe9;
    }
    .hidden { display: none; }
    table { width: 100%; margin-top: 1rem; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 0.4rem; text-align: center; }
    .admin { background: #f9f9f9; padding: 1rem; margin-top: 1rem; border: 1px solid #ccc; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Palacio Skins Scorecard</h1>

  <div id="scorecard"></div>

  <form id="scoreForm">
    <label for="player">Player:</label>
    <select id="player" required>
  <option value="">-- Select Player --</option>
  <option>Alex Kim</option>
  <option>Alex Mattfolk</option>
  <option>Beau Schmitt</option>
  <option>Brett Heater</option>
  <option>Buzz Gibbs</option>
  <option>Chris Burman</option>
  <option>Commish</option>
  <option>Craig Sanger</option>
  <option>Curtis Strand</option>
  <option>Dan Gilliam</option>
  <option>Daniel Nunez</option>
  <option>Elijah Peterson</option>
  <option>Eric Ingersoll</option>
  <option>Erik Allison</option>
  <option>Gary Dilworth</option>
  <option>Gavin Lodge</option>
  <option>Jared Sanderson</option>
  <option>Jay Nakamura</option>
  <option>Jeff Jordan</option>
  <option>Jermell Mitchell</option>
  <option>Jim Giubilato</option>
  <option>Jory Adam</option>
  <option>Mark Gresser</option>
  <option>Mike Hurvitz</option>
  <option>Neil Gerber</option>
  <option>Roman Alper</option>
  <option>Ryan Haight</option>
  <option>Sean Edwards</option>
  <option>Steve Bonner</option>
  <option>Steve Jess</option>
  <option>Other</option>
</select>
    <input id="otherPlayer" placeholder="Enter player name" class="hidden" />

    <label for="week">Week Number:</label>
    <input type="number" id="week" min="1" required />

    <button id="startRound" type="button">Start Round</button>
    <div id="holeSection"></div>
  </form>

  <div id="summary">
<pre id="recap" style="margin-top:1rem; white-space:pre-wrap; border:1px dashed #999; padding:1rem;"></pre>

  <script>
    const SUPABASE_URL = 'https://htsipaxeqaumxntsrsvx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0c2lwYXhlcWF1bXhudHNyc3Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMjU1NDQsImV4cCI6MjA2NjkwMTU0NH0.AY4mcj85_xWSz2HI2A16kigH58PqAFoEDqZgULcen88';
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const maxHoles = 9;
    let currentHole = 1;
    const scores = {};

    const form = document.getElementById('scoreForm');
    const holeSection = document.getElementById('holeSection');
    const scorecard = document.getElementById('scorecard');
    const summary = document.getElementById('summary');
    const adminPanel = document.getElementById('adminTools');
    const startRoundButton = document.getElementById('startRound');

    document.getElementById('player').addEventListener('change', (e) => {
  document.getElementById('otherPlayer').classList.toggle('hidden', e.target.value !== 'Other');
});

    function renderScorecard() {
  let html = '<h3>Your Scorecard</h3>';
  html += '<table><tr><th>Hole</th>';
  for (let i = 1; i <= maxHoles; i++) html += `<th>${i}</th>`;
  html += '</tr><tr><td>Score</td>';
  for (let i = 1; i <= maxHoles; i++) html += `<td>${scores[i] || '-'}</td>`;
  html += '</tr></table>';
  scorecard.innerHTML = html;

}

function renderHoleForm() {
      holeSection.innerHTML = '';
      if (currentHole > maxHoles) {
        holeSection.innerHTML = '<p>All holes submitted. <button onclick="location.reload()">Restart</button></p>';
        return;
      }
      const div = document.createElement('div');
      div.innerHTML = `
        <h3>Hole ${currentHole}</h3>
        <div class="score-options">
          <label><input type="radio" name="score" value="1"> Hole-in-One</label>
          <label><input type="radio" name="score" value="2"> Birdie</label>
          <div id="chipInContainer" class="hidden">
            <label><input type="checkbox" id="chipIn"> Chip-in</label>
          </div>
          <label><input type="radio" name="score" value="3+"> Par or Worse</label>
        </div>
        <div id="ctpContainer" class="${currentHole === 9 ? '' : 'hidden'}">
          <label><input type="checkbox" id="ctp"> Closest to the Pin</label>
        </div>
        <button type="button" onclick="handleHoleSubmit()">Submit Hole</button>
      `;
      holeSection.appendChild(div);

      const birdieRadio = div.querySelector('input[value="2"]');
      birdieRadio.addEventListener('change', () => document.getElementById('chipInContainer').classList.remove('hidden'));
      div.querySelectorAll('input[name="score"]').forEach(input => {
        if (input.value !== '2') input.addEventListener('change', () => document.getElementById('chipInContainer').classList.add('hidden'));
      });
    }

    async function handleHoleSubmit() {
  const player = document.getElementById('player').value === 'Other'
    ? document.getElementById('otherPlayer').value.trim()
    : document.getElementById('player').value;
  const week = parseInt(document.getElementById('week').value);
  const scoreInput = holeSection.querySelector('input[name="score"]:checked');
  if (!player || !week || !scoreInput) return alert('Fill in all fields');

  let score = scoreInput.value;
  const chipIn = document.getElementById('chipIn')?.checked;
  if (score === '2' && chipIn) score = '2*';
  const ctp = document.getElementById('ctp')?.checked || false;

  const submission = { player, week_number: week, hole: currentHole, score, ctp };

  try {
    const { error } = await client.from('Submissions').insert([submission]);
    if (error) throw error;
  } catch (err) {
    alert('Error submitting: ' + err.message);
    return;
  }

  scores[currentHole] = score;
  renderScorecard();
  currentHole++;

  renderLiveSummary();
    function listenToRecap(weekNumber) {
      client.channel('public:Recaps')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'Recaps',
          filter: `week_number=eq.${weekNumber}`
        }, payload => {
          document.getElementById('recap').textContent = payload.new.recap_text;
        })
        .subscribe();
    }

    function listenToLiveScores(weekNumber) {
      client.channel('public:Submissions')
        .on(
          'postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'Submissions', filter: `week_number=eq.${weekNumber}` },
          () => renderLiveSummary()
        )
        .subscribe();
    }
  renderHoleForm();
      const parsedWeek = parseInt(week);
      listenToLiveScores(parsedWeek);
      listenToRecap(parsedWeek);
}

    renderHoleForm();

    startRoundButton.addEventListener('click', () => {
      const player = document.getElementById('player').value;
      const week = document.getElementById('week').value;
      if (!player || !week) return alert('Please select a player and enter a week number first.');
      startRoundButton.classList.add('hidden');
      currentHole = 1;
      for (let i = 1; i <= maxHoles; i++) delete scores[i];
      renderScorecard();
      renderHoleForm();
    });

    function renderLiveSummary() {
      const week = parseInt(document.getElementById('week').value);
      if (!week) return;
      client
        .from('Submissions')
        .select('*')
        .eq('week_number', week)
        .then(({ data, error }) => {
          if (error || !data) {
            summary.innerHTML = '<p>Error loading summary</p>';
            return;
          }

          const holeStats = {};
          for (let i = 1; i <= 9; i++) {
            holeStats[i] = { birdies: 0, chipins: 0, aces: 0 };
          }

          data.forEach(({ hole, score }) => {
            if (!holeStats[hole]) return;
            if (score === '1') holeStats[hole].aces++;
            else if (score === '2') holeStats[hole].birdies++;
            else if (score === '2*') holeStats[hole].chipins++;
          });

          let html = '<table><tr><th>Hole</th><th>Birdies</th><th>Chip-ins</th><th>Aces</th></tr>';
          for (let i = 1; i <= 9; i++) {
            const h = holeStats[i];
            html += `<tr><td>${i}</td><td>${h.birdies}</td><td>${h.chipins}</td><td>${h.aces}</td></tr>`;
          }
          html += '</table>';
          summary.innerHTML = html;
        });
    }

    renderLiveSummary();

    
    document.getElementById('player').addEventListener('change', () => {
  const player = document.getElementById('player').value;
  const weekInput = document.getElementById('week');
  const week = weekInput.value || 1;
  if (["Commish", "Craig Sanger"].includes(player)) {
    adminPanel.classList.remove("hidden");
    adminPanel.innerHTML = `
      <h3>Admin Tools</h3>
      <label>Week to Finalize: <input type="number" id="finalWeek" min="1" value="${week}" /></label>
      <button onclick="finalizeScores()">💰 Finalize Scores & Calculate Payouts</button>
      <button onclick="clearWeek()">🗑 Clear Week</button>
      <pre id="adminResults">Admin Results will appear here.</pre>
    `;
  } else {
    adminPanel.classList.add("hidden");
  }
});

async function finalizeScores() {
  const week = parseInt(document.getElementById('finalWeek').value);
  if (!week) return alert('Enter a week number.');

  const { data, error } = await client
    .from('Submissions')
    .select('*')
    .eq('week_number', week);

  if (error || !data || data.length === 0) {
    document.getElementById('adminResults').textContent = 'Error or no data for this week.';
    return;
  }

  let recap = '';
  const byHole = {};
  for (let i = 1; i <= 9; i++) byHole[i] = [];
  data.forEach(entry => byHole[entry.hole].push(entry));

  const aceWinners = data.filter(d => d.score === '1');

  if (aceWinners.length > 0) {
    const names = aceWinners.map(a => a.player).join(', ');
    recap += `🎯 Ace Mode: $300 split among ${names}
`;
  } else {
    let shares = {};
    let totalShares = 0;
    for (let h = 1; h <= 9; h++) {
      const scores = byHole[h];
      const birdies = scores.filter(s => s.score === '2');
      const chipins = scores.filter(s => s.score === '2*');
      const aces = scores.filter(s => s.score === '1');
      if (aces.length > 0) {
        const names = aces.map(p => p.player).join(', ');
        recap += `Hole ${h}: Ace by ${names}
`;
      } else if (birdies.length === 1 && chipins.length === 0) {
        shares[birdies[0].player] = (shares[birdies[0].player] || 0) + 1;
        totalShares++;
        recap += `Hole ${h}: Skin to ${birdies[0].player}
`;
      } else if (chipins.length === 1 && birdies.length === 0) {
        shares[chipins[0].player] = (shares[chipins[0].player] || 0) + 2;
        totalShares += 2;
        recap += `Hole ${h}: Skin (chip-in) to ${chipins[0].player}
`;
      } else if (birdies.length > 0 || chipins.length > 0) {
        const bNames = birdies.map(b => b.player).join(', ');
        const cNames = chipins.map(c => c.player).join(', ');
        let names = [];
        if (bNames) names.push(`Birdies by ${bNames}`);
        if (cNames) names.push(`Chip-in Birdies by ${cNames}`);
        recap += `Hole ${h}: No skin - ${names.join(' and ')}
`;
      } else {
        recap += `Hole ${h}: No action
`;
      }
      }
    const valuePerShare = totalShares > 0 ? 300 / totalShares : 0;
    recap += `
💸 Payouts:
`;
    for (const player in shares) {
      const amount = (shares[player] * valuePerShare).toFixed(2);
      recap += `${player}: $${amount}
`;
    }
  }

  const ctp = data.filter(d => d.hole === 9 && d.ctp);
  if (ctp.length > 0) {
    const last = ctp.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
    recap += `
📍 CTP Winner: ${last.player} ($30)`;
  } else {
    recap += `
📍 CTP Winner: Commish (default)`;
  }

  document.getElementById('adminResults').textContent = recap;
  await client.from('Recaps').upsert({ week_number: week, recap_text: recap });
}

async function clearWeek() {
  const week = parseInt(document.getElementById('finalWeek').value);
  if (!confirm(`Clear all submissions for week ${week}?`)) return;
  const { error } = await client
    .from('Submissions')
    .delete()
    .eq('week_number', week);

  if (error) {
    document.getElementById('adminResults').textContent = 'Error clearing week.';
  } else {
    document.getElementById('adminResults').textContent = `Week ${week} cleared.`;
  }
}

  </script>
</body>
</html>
