<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palacio Skins Scorecard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      max-width: 900px;
      margin: auto;
      background: #f9f9f9;
    }
    h2 {
      margin-top: 2rem;
      border-bottom: 2px solid #ccc;
      padding-bottom: 0.5rem;
    }
    label, select, input, button {
      display: block;
      margin: 0.5rem 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: center;
    }
    .admin-only {
      background: #eef;
      padding: 1rem;
      margin-top: 2rem;
    }
    .hidden { display: none; }
    @media (max-width: 600px) {
      input, select, button { width: 100%; }
    }
  </style>
</head>
<body>
  <h1>Palacio Skins Scorecard</h1>

  <section id="submission">
    <h2>Player Score Submission</h2>
    <label for="player">Player</label>
    <select id="player">
      <option value="" disabled selected>Select a player</option>
    </select>

    <label for="week">Week Number</label>
    <input type="number" id="week" min="1">

    <div id="holeInput">
      <h3 id="holeLabel">Hole 1</h3>
      <label><input type="radio" name="score" value="1"> Hole-in-One</label>
      <label><input type="radio" name="score" value="2"> Birdie</label>
      <label><input type="radio" name="score" value="2*"> Chip-in Birdie</label>
      <label><input type="radio" name="score" value="3+" checked> Par or Worse</label>
      <label id="ctpCheckbox" class="hidden">
        <input type="checkbox" id="ctp"> Closest to Pin (Hole 9)
      </label>
      <button id="submitHole">Submit Hole</button>
    </div>
  </section>

  <section id="scorecard">
    <h2>Live Scorecard</h2>
    <div id="scorecardTable"></div>
  </section>

  <section id="summary">
    <h2>Live Summary</h2>
    <div id=\"summaryTable\"></div>

  </section>

  <section id="admin" class="admin-only hidden">
  <h2>Admin Tools</h2>
  <button id="calculatePayouts">Calculate Payouts</button>
  <button id="clearWeek">Clear Week</button>
  <button id="clearWeekConfirm">Confirm Clear</button>
  <pre id="payoutResults"></pre>
</section>

  <section id="recap">
    <h2>Recap Output</h2>
    <pre id="recapOutput"></pre>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const clearWeekBtn = document.getElementById('clearWeekConfirm');
      clearWeekBtn.addEventListener('click', async () => {
        if (!weekInput.value) {
          alert('Please select a week number first.');
          return;
        }
        const week = parseInt(weekInput.value);
        if (!confirm(`Are you sure you want to delete all data for week ${week}?`)) return;
        const { error } = await supabase.from('Submissions').delete().eq('week_number', week);
        if (error) {
          alert('Error clearing week: ' + error.message);
        } else {
          alert(`Week ${week} data cleared.`);
          loadLiveScorecard(week);
          loadLiveSummary(week);
          document.getElementById('payoutResults').textContent = '';
        }
      });
      const calculateBtn = document.getElementById('calculatePayouts');
      calculateBtn.addEventListener('click', () => {
        if (weekInput.value) calculatePayouts(parseInt(weekInput.value));
      });

      const players = ["Commish","Craig Sanger","Alex Kim","Alex Mattfolk","Beau Schmitt","Brett Heater","Buzz Gibbs","Chris Burman","Curtis Strand","Dan Gilliam","Daniel Nunez","Elijah Peterson","Eric Ingersoll","Erik Allison","Gavin Lodge","Gary Dilworth","Jared Sanderson","Jay Nakamura","Jeff Jordan","Jermell Mitchell","Jim Giubilato","Jory Adam","Mark Gresser","Mike Hurvitz","Neil Gerber","Roman Alper","Ryan Haight","Sean Edwards","Steve Bonner","Steve Jess"];
      const playerSelect = document.getElementById('player');
      const weekInput = document.getElementById('week');
      players.forEach(p => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = p;
        playerSelect.appendChild(opt);
      });

      const adminTools = document.getElementById('admin');
      playerSelect.addEventListener('change', () => {
        const isAdmin = ["Craig Sanger", "Commish"].includes(playerSelect.value);
        adminTools.classList.toggle('hidden', !isAdmin);
      });

      const scoreRadios = document.querySelectorAll('input[name="score"]');
      const submitHoleBtn = document.getElementById('submitHole');
      const holeLabel = document.getElementById('holeLabel');
      const ctpCheckbox = document.getElementById('ctpCheckbox');
      const ctp = document.getElementById('ctp');
      const holeInputDiv = document.getElementById('holeInput');

      let currentHole = 1;

      function updateHoleLabel() {
        holeLabel.textContent = `Hole ${currentHole}`;
        ctpCheckbox.classList.toggle('hidden', currentHole !== 9);
      }

      const supabase = window.supabase.createClient(
        'https://htsipaxeqaumxntsrsvx.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0c2lwYXhlcWF1bXhudHNyc3Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMjU1NDQsImV4cCI6MjA2NjkwMTU0NH0.AY4mcj85_xWSz2HI2A16kigH58PqAFoEDqZgULcen88'
      );

      submitHoleBtn.addEventListener('click', async () => {
        const player = playerSelect.value;
        const week = parseInt(weekInput.value);
        const scoreEl = document.querySelector('input[name="score"]:checked');
        if (!player || !week || week < 1 || !scoreEl || currentHole > 9) {
          alert('Fill in all fields');
          return;
        }

        const score = scoreEl.value;
        const isCTP = (currentHole === 9) ? ctp.checked : false;

        try {
          const { error } = await supabase.from('Submissions').insert({
            player,
            week_number: week,
            hole: currentHole,
            score,
            ctp: isCTP
          });

          if (error) throw error;

          // Success: update UI and state
          currentHole++;
          if (currentHole <= 9) {
            updateHoleLabel();
      if (weekInput.value) {
  loadLiveScorecard(parseInt(weekInput.value));
  loadLiveSummary(parseInt(weekInput.value));
}
            document.querySelector('input[value="3+"]').checked = true;
            ctp.checked = false;
          } else {
            holeInputDiv.innerHTML = `
              <p>‚úÖ All 9 holes submitted!</p>
              <button onclick="location.reload()">Start Over</button>
            `;
          }

        } catch (err) {
          alert('Error submitting: ' + err.message);
        }
      });

      updateHoleLabel();
      if (weekInput.value) {
  loadLiveScorecard(parseInt(weekInput.value));
  loadLiveSummary(parseInt(weekInput.value));
}
    });
  </script>
<script>
  const supabase = window.supabase.createClient(
    'https://htsipaxeqaumxntsrsvx.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0c2lwYXhlcWF1bXhudHNyc3Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMjU1NDQsImV4cCI6MjA2NjkwMTU0NH0.AY4mcj85_xWSz2HI2A16kigH58PqAFoEDqZgULcen88'
  );

  function loadLiveSummary(weekNumber) {
    supabase
      .from('Submissions')
      .select('*')
      .eq('week_number', weekNumber)
      .then(({ data, error }) => {
        if (error) {
          console.error('Error loading summary:', error.message);
          return;
        }

        const summary = Array.from({ length: 9 }, (_, i) => ({
          hole: i + 1,
          birdies: [],
          chipIns: [],
          aces: []
        }));

        data.forEach(entry => {
          const holeData = summary[entry.hole - 1];
          if (entry.score === '1') holeData.aces.push(entry.player);
          else if (entry.score === '2') holeData.birdies.push(entry.player);
          else if (entry.score === '2*') holeData.chipIns.push(entry.player);
        });

        let html = '<table><thead><tr><th>Hole</th><th>Aces</th><th>Birdies</th><th>Chip-ins</th></tr></thead><tbody>';
        summary.forEach(row => {
          html += `<tr><td>${row.hole}</td><td>${row.aces.join(', ')}</td><td>${row.birdies.join(', ')}</td><td>${row.chipIns.join(', ')}</td></tr>`;
        });
        html += '</tbody></table>';

        document.getElementById('summaryTable').innerHTML = html;
      });
  }

  function calculatePayouts(weekNumber) {
    supabase
      .from('Submissions')
      .select('*')
      .eq('week_number', weekNumber)
      .then(({ data, error }) => {
        if (error) {
          console.error('Error fetching data for payouts:', error.message);
          return;
        }

        const results = {
          aces: [],
          shares: {},
          ctpEntries: []
        };

        const holeScores = Array.from({ length: 9 }, () => ({ birdies: [], chipIns: [], aces: [] }));

        data.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

        data.forEach(entry => {
          const h = entry.hole - 1;
          if (!holeScores[h]) return;

          if (entry.score === '1') {
            holeScores[h].aces.push(entry.player);
            if (!results.aces.includes(entry.player)) results.aces.push(entry.player);
          } else if (entry.score === '2') {
            holeScores[h].birdies.push(entry.player);
          } else if (entry.score === '2*') {
            holeScores[h].chipIns.push(entry.player);
          }

          if (entry.hole === 9 && entry.ctp) {
            results.ctpEntries.push(entry.player);
          }
        });

        let recap = '';
        let payoutLines = [];

        if (results.aces.length > 0) {
          const perAce = 300 / results.aces.length;
          recap += 'üéØ Hole-in-One Winner(s):
';
          results.aces.forEach(p => {
            recap += `- ${p}: $${perAce.toFixed(2)}
`;
          });
        } else {
          // Skins
          let totalShares = 0;
          for (let i = 0; i < 9; i++) {
            const { birdies, chipIns } = holeScores[i];
            const holeNum = i + 1;
            recap += `Hole ${holeNum}: `;

            if (birdies.length === 1 && chipIns.length === 0) {
              results.shares[birdies[0]] = (results.shares[birdies[0]] || 0) + 1;
              recap += `1 birdie (${birdies[0]}), no chip-ins, no aces
`;
              totalShares++;
            } else if (chipIns.length === 1 && birdies.length === 0) {
              results.shares[chipIns[0]] = (results.shares[chipIns[0]] || 0) + 2;
              recap += `1 chip-in (${chipIns[0]}), no birdies, no aces
`;
              totalShares += 2;
            } else {
              recap += `${birdies.length} birdie(s), ${chipIns.length} chip-in(s), no aces
`;
            }
          }

          if (totalShares > 0) {
            const perShare = 300 / totalShares;
            recap = 'üí∏ Skin Results:
' + Object.entries(results.shares).map(([p, s]) => `- ${p}: $${(s * perShare).toFixed(2)} (${s} shares)`).join('
') + '

üèÅ Full Recap:
' + recap;
          } else {
            recap = 'No skins awarded.

üèÅ Full Recap:
' + recap;
          }
        }

        recap += '
üéØ CTP Sequence: ' + (results.ctpEntries.join(' ‚Üí ') || 'None');
        const finalCTP = results.ctpEntries.at(-1) || 'Commish';
        recap += `
üéØ Final CTP Winner: ${finalCTP} ($30)`;

        document.getElementById('payoutResults').textContent = recap;
      });
  }
</script>
</body>
</html>
